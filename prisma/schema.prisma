// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  MANAGER
  SALESPERSON
  ACCOUNTANT
  WAREHOUSE_MANAGER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TransactionType {
  SALE
  PURCHASE
  RETURN
  ADJUSTMENT
  TRANSFER
  DAMAGE
  EXPIRY
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  MOBILE_MONEY
  CHEQUE
  CREDIT
  CRYPTO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIAL
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
  OUT_OF_STOCK
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum CustomerType {
  RETAIL
  WHOLESALE
  VIP
  CORPORATE
}

enum NotificationType {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LocationType {
  STORE
  WAREHOUSE
  OFFICE
  DISTRIBUTION_CENTER
}

model User {
  id          String     @id @default(cuid())
  email       String     @unique
  username    String?    @unique
  firstName   String
  lastName    String
  phone       String?
  role        Role       @default(SALESPERSON)
  status      UserStatus @default(ACTIVE)
  password    String
  lastLogin   DateTime?
  locationId  String?
  avatar      String?
  preferences Json?
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret String?
  
  // Relations
  location    Location?  @relation(fields: [locationId], references: [id])
  sales       Sale[]
  purchases   Purchase[]
  auditLogs   AuditLog[]
  notifications Notification[]
  tasks       Task[]
  expenses    Expense[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@map("users")
}

model Location {
  id          String       @id @default(cuid())
  name        String
  type        LocationType @default(STORE)
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  phone       String?
  email       String?
  managerId   String?
  isActive    Boolean      @default(true)
  
  // Relations
  users       User[]
  products    Product[]
  sales       Sale[]
  purchases   Purchase[]
  inventory   Inventory[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@map("locations")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("categories")
}

model Product {
  id            String        @id @default(cuid())
  name          String
  description   String?
  sku           String        @unique
  barcode       String?       @unique
  rfidTag       String?       @unique
  price         Decimal       @db.Decimal(10, 2)
  cost          Decimal       @db.Decimal(10, 2)
  minStock      Int           @default(0)
  maxStock      Int?
  currentStock  Int           @default(0)
  unit          String        @default("piece")
  status        ProductStatus @default(ACTIVE)
  categoryId    String
  supplierId    String?
  locationId    String?
  taxRate       Decimal       @default(0) @db.Decimal(5, 2)
  image         String?
  weight        Decimal?      @db.Decimal(8, 3)
  dimensions    String?
  expiryDate    DateTime?
  reorderPoint  Int?
  isSerialized  Boolean       @default(false)
  isPerishable  Boolean       @default(false)
  tags          String[]
  
  // Relations
  category      Category      @relation(fields: [categoryId], references: [id])
  supplier      Supplier?     @relation(fields: [supplierId], references: [id])
  location      Location?     @relation(fields: [locationId], references: [id])
  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]
  stockMovements StockMovement[]
  inventory     Inventory[]
  serialNumbers ProductSerial[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("products")
}

model ProductSerial {
  id          String   @id @default(cuid())
  productId   String
  serialNumber String  @unique
  isActive    Boolean  @default(true)
  
  // Relations
  product     Product  @relation(fields: [productId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("product_serials")
}

model Inventory {
  id          String   @id @default(cuid())
  productId   String
  locationId  String
  quantity    Int
  reserved    Int      @default(0)
  available   Int      @default(0)
  
  // Relations
  product     Product  @relation(fields: [productId], references: [id])
  location    Location @relation(fields: [locationId], references: [id])
  
  @@unique([productId, locationId])
  @@map("inventory")
}

model Supplier {
  id          String    @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  contactPerson String?
  taxId       String?
  creditLimit Decimal?  @db.Decimal(10, 2)
  paymentTerms String?
  rating      Int?
  isActive    Boolean   @default(true)
  
  // Relations
  products    Product[]
  purchases   Purchase[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("suppliers")
}

model Customer {
  id          String       @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  taxId       String?
  creditLimit Decimal?     @db.Decimal(10, 2)
  type        CustomerType @default(RETAIL)
  loyaltyPoints Int        @default(0)
  totalSpent  Decimal      @default(0) @db.Decimal(12, 2)
  lastPurchase DateTime?
  isActive    Boolean      @default(true)
  notes       String?
  
  // Relations
  sales       Sale[]
  returns     Return[]
  loyaltyTransactions LoyaltyTransaction[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@map("customers")
}

model Sale {
  id            String        @id @default(cuid())
  saleNumber    String        @unique
  customerId    String?
  userId        String
  locationId    String?
  subtotal      Decimal       @db.Decimal(10, 2)
  taxAmount     Decimal       @db.Decimal(10, 2)
  discountAmount Decimal      @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)
  notes         String?
  terminalId    String?
  isRefunded    Boolean       @default(false)
  refundReason  String?
  
  // Relations
  customer      Customer?     @relation(fields: [customerId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  location      Location?     @relation(fields: [locationId], references: [id])
  items         SaleItem[]
  payments      Payment[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("sales")
}

model SaleItem {
  id          String  @id @default(cuid())
  saleId      String
  productId   String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  discount    Decimal @default(0) @db.Decimal(10, 2)
  taxRate     Decimal @db.Decimal(5, 2)
  total       Decimal @db.Decimal(10, 2)
  
  // Relations
  sale        Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id])
  
  @@map("sale_items")
}

model Return {
  id          String   @id @default(cuid())
  returnNumber String  @unique
  saleId      String?
  customerId  String
  userId      String
  reason      String
  total       Decimal  @db.Decimal(10, 2)
  status      PaymentStatus @default(PENDING)
  
  // Relations
  customer    Customer @relation(fields: [customerId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("returns")
}

model Purchase {
  id            String         @id @default(cuid())
  purchaseNumber String        @unique
  supplierId    String
  userId        String
  locationId    String?
  subtotal      Decimal        @db.Decimal(10, 2)
  taxAmount     Decimal        @db.Decimal(10, 2)
  total         Decimal        @db.Decimal(10, 2)
  status        OrderStatus    @default(DRAFT)
  expectedDate  DateTime?
  receivedDate  DateTime?
  notes         String?
  
  // Relations
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  location      Location?      @relation(fields: [locationId], references: [id])
  items         PurchaseItem[]
  payments      Payment[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("purchases")
}

model PurchaseItem {
  id          String   @id @default(cuid())
  purchaseId  String
  productId   String
  quantity    Int
  unitCost    Decimal  @db.Decimal(10, 2)
  taxRate     Decimal  @db.Decimal(5, 2)
  total       Decimal  @db.Decimal(10, 2)
  
  // Relations
  purchase    Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])
  
  @@map("purchase_items")
}

model Payment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  reference     String?
  notes         String?
  saleId        String?
  purchaseId    String?
  transactionId String?
  
  // Relations
  sale          Sale?         @relation(fields: [saleId], references: [id])
  purchase      Purchase?     @relation(fields: [purchaseId], references: [id])
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("payments")
}

model StockMovement {
  id          String          @id @default(cuid())
  productId   String
  type        TransactionType
  quantity    Int
  reference   String?
  notes       String?
  locationId  String?
  
  // Relations
  product     Product         @relation(fields: [productId], references: [id])
  
  createdAt   DateTime        @default(now())
  
  @@map("stock_movements")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  entity      String
  entityId    String
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  
  // Relations
  user        User?    @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@map("audit_logs")
}

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("settings")
}

model Notification {
  id          String             @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  priority    NotificationPriority @default(MEDIUM)
  isRead      Boolean            @default(false)
  data        Json?
  
  // Relations
  user        User               @relation(fields: [userId], references: [id])
  
  createdAt   DateTime           @default(now())
  
  @@map("notifications")
}

model Task {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  status      String   @default("PENDING")
  priority    String   @default("MEDIUM")
  dueDate     DateTime?
  completedAt DateTime?
  
  // Relations
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("tasks")
}

model Expense {
  id          String   @id @default(cuid())
  userId      String
  category    String
  amount      Decimal  @db.Decimal(10, 2)
  description String
  date        DateTime
  receipt     String?
  
  // Relations
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("expenses")
}

model LoyaltyTransaction {
  id          String   @id @default(cuid())
  customerId  String
  points      Int
  type        String   // EARN, REDEEM, EXPIRE
  description String?
  
  // Relations
  customer    Customer @relation(fields: [customerId], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@map("loyalty_transactions")
}

model FileUpload {
  id          String   @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  path        String
  uploadedBy  String?
  
  createdAt   DateTime @default(now())
  
  @@map("file_uploads")
}